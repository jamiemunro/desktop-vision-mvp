<!doctype html><html><body style="font:14px sans-serif">
<button id="start">Start Audio/Video Capture</button>
<button id="stop" disabled>Stop Audio/Video Capture</button>
<button id="bookmark">Bookmark</button>
<button id="archive">Archive Old Sessions</button>
<div id="status"></div>
<video id="v" autoplay muted playsinline style="max-width:100%"></video>
<script>
const v = document.getElementById('v'); const status = document.getElementById('status');
let captureInterval = null;
async function start() {
  try {
    status.textContent = 'Starting audio recording...';
    
    // Start audio recording
    const audioResult = await window.api.startAudio();
    if (!audioResult.success) {
      status.textContent = `Audio start failed: ${audioResult.message}`;
      return;
    }
    
    status.textContent = 'Starting video capture...';
    
    // Start video capture
    const sources = await window.api.getSources();
    const sourceId = sources[0].id;
    const stream = await navigator.mediaDevices.getUserMedia({ audio:false, video:{ mandatory:{ chromeMediaSource:'desktop', chromeMediaSourceId: sourceId } } });
    v.srcObject = stream;
    
    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
    captureInterval = setInterval(() => {
      if (!v.videoWidth) return;
      canvas.width = v.videoWidth; canvas.height = v.videoHeight;
      ctx.drawImage(v,0,0);
      canvas.toBlob(async (blob)=> {
        const arr = new Uint8Array(await blob.arrayBuffer());
        window.api.sendFrame({ timestamp: Date.now(), jpgBuffer: arr });
        status.textContent = `Recording - Last frame: ${new Date().toLocaleTimeString()}`;
      }, 'image/jpeg', 0.6);
    }, 500); // ~2 fps
    
    document.getElementById('start').disabled = true;
    document.getElementById('stop').disabled = false;
    status.textContent = 'Audio/Video recording started';
    
  } catch (error) {
    status.textContent = `Start failed: ${error.message}`;
    console.error('Start error:', error);
  }
}
async function stop() {
  try {
    status.textContent = 'Stopping capture...';
    
    // Stop video capture
    if (captureInterval) {
      clearInterval(captureInterval);
      captureInterval = null;
    }
    if (v.srcObject) {
      v.srcObject.getTracks().forEach(track => track.stop());
      v.srcObject = null;
    }
    
    // Stop audio recording
    const audioResult = await window.api.stopAudio();
    if (!audioResult.success) {
      console.warn('Audio stop warning:', audioResult.message);
    }
    
    document.getElementById('start').disabled = false;
    document.getElementById('stop').disabled = true;
    status.textContent = 'Audio/Video capture stopped';
    
  } catch (error) {
    status.textContent = `Stop failed: ${error.message}`;
    console.error('Stop error:', error);
  }
}
document.getElementById('start').onclick = start;
document.getElementById('stop').onclick = stop;
document.getElementById('bookmark').onclick = ()=> window.api.bookmark(prompt('Label?')||'Bookmark');
document.getElementById('archive').onclick = async () => {
  status.textContent = 'Checking sessions for archiving...';
  const result = await window.api.archiveSessions();
  status.textContent = result.success ? 'Archiving started (check console)' : `Archive failed: ${result.message}`;
};
</script>
</body></html>